---
title: "Lab 5 new"
author: "Julie Heng"
date: "10/07/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/Jules/Documents/UMich_Bio201_F19/")
```

# Load packages

```{r Load packages, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
library(readxl)
library(broom)
library(cowplot)
library(agricolae)
set.seed(7)
```

# Relationship between data structure and results
There are several factors of data sets which influence the results of statistical tests: 

* Values: numeric values of each data point
* Sample size (n): number of data points in each group being compared 
* Variance: spread of the data within each group
* Effect size: size of the difference in mean, strength of the correlation, etc. 

Before getting into the details of use and interpretation of formal statistical tests, we are going to do an exercise with random number vectors to illustrate how each of these factors effects your intuitive interpretation of the results. 

Run the code blocks below to create two vectors with the listed means, sample size, variation (via SD). Combine these vectors into a data frame and plot. Discuss with your neighbor, then under each plot write if you would determine these two samples to be equal, and which factors influenced your decision. 

### Example 1
```{r}
sample1 <- rnorm(6, mean=12, sd = 1) #vector1 

sample2 <- rnorm(6, mean=15, sd = 1) #vector2 

df1 <- cbind(sample1, sample2) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df1, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + #shows median & quartiles 
  geom_jitter(aes(color = samples)) + #jitter = individual points per category 
  theme(legend.position = "none")

#While the samples have the same number of data points, they appear unequal (different means)
```

### Example 2
```{r}
sample3 <- rnorm(6, mean=12, sd = 3) 
sample4 <- rnorm(6, mean=15, sd = 4) 

df2 <- cbind(sample3, sample4) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df2, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + 
  geom_jitter(aes(color = samples)) + 
  theme(legend.position = "none")

#These plots appear more equal, visually, or at least more similar. 
```

### Example 3
```{r}
sample5 <- rnorm(20, mean=12, sd = 1) 
sample6 <- rnorm(20, mean=15, sd = 1) 

df3 <- cbind(sample5, sample6) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df3, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + 
  geom_jitter(aes(color = samples)) + 
  theme(legend.position = "none")

#With a lower sd, the difference between the two samples is much more obviously unequal.
```

### Example 4
```{r}
sample7 <- rnorm(20, mean=12, sd = 3) 
sample8 <- rnorm(20, mean=15, sd = 4) 

df4 <- cbind(sample7, sample8) %>% #combine vectors into dataframe
  as.data.frame() %>% 
  gather(key = "samples", value = "numbers") %>% #make long format
  mutate(samples = as.factor(samples)) #convert to factor for plot

ggplot(data = df4, aes(x = samples, #plot data frame 
                     y = numbers)) + 
  geom_boxplot(aes(color = samples)) + 
  geom_jitter(aes(color = samples)) + 
  theme(legend.position = "none")

#Lots of overlap, but the means are quite different and are unequal.
```

# Import data 

Import the data frame you generated last week that has the mean weekly SCFAs. Import both long and wide formats of these data. During import convert column names to snake case.  
```{r include=FALSE}
scfa_long <- read_delim("Lab5/curated_data/SCFA_wkly_long.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower) %>%
  mutate(semester = factor(semester,
                           levels=c("Winter2015", "Fall2015", 
                                    "Winter2016", "Fall2016", 
                                    "Winter2017", "Fall2017", 
                                    "Winter2018", "Fall2018", 
                                    "Winter2019"), ordered = TRUE)) %>% 
  rename_all(tolower)
  

scfa_wide <- read_delim("Lab5/curated_data/SCFA_wkly_wide.txt", 
                        delim = "\t", col_names = TRUE, trim_ws = TRUE, na = c("NA")) %>%
  rename_all(tolower) %>%
  mutate(semester = factor(semester,
                           levels=c("Winter2015", "Fall2015", 
                                    "Winter2016", "Fall2016", 
                                    "Winter2017", "Fall2017", 
                                    "Winter2018", "Fall2018", 
                                    "Winter2019"), ordered = TRUE)) %>% 
  rename_all(tolower)
```


# Introduction

As mentioned earlier this semester, one of the overarching questions for this course is: "Does the consumption of a prebiotic (fiber supplement) affect the gut microbiome?" As you have been learning, there are many elements to this: fermentation products, community composition, pH, and host lifestyle. In most of the lab exercise today we will attempt to answer part of this question using the change in fermentation products (specifically butyrate) in individuals who consumed potato starch. Today we will introduce several types of plots, and discuss when they are appropriate for certain families of data, and we will conduct some basic statistical tests for these plots. 

```{r}
# use select + starts_with or ends_with to retain/drop multiple columns with similar names
butyrate_wide <- scfa_wide %>%
  select(-starts_with("ace"), -ends_with("ace"), 
         -starts_with("pro"), -ends_with("pro"),
         -starts_with("total"), -ends_with("total"),
         -starts_with("delta")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT") %>%
  na.omit(but_wk1, but_wk3)
```

# 1 continuous and 1 categorical (discrete) variable 

In this lesson we are going to use the term categorical, however these are called discrete on the ggplot cheatsheet. 

### Violin plots
In the section above we subset by fiber supplement and fermentation product. One of the variations of fiber supplement we tested was frequency (once or twice daily). In the code below we are going to generate a plot that illustrates the butyrate concentration when individuals are consuming fiber supplements at different frequencies. 

Violin plots (or geom_boxplot + geom_jitter) are the recommended way to represent these families of data, they show the variation and the range, are easy to annotate with a mean (geom_errobar), you can easily add individual data points (geom_violin + geom_jitter), and do not obfuscate data in the manner of a bar plot. We will not use bar plots in this course. 

Subset the long data frame imported above for butyrate measurements only, supplement type is potato starch (BRMPS or LOODAT), drop any samples from Winter 2015, filter for individuals who were quantity compliant, make sure to keep the frequency and semester columns. 
```{r}
butyrate_long <- scfa_long %>%
  select(-starts_with("ace"), -starts_with("pro"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS" | supplement_consumed == "LOODAT",
         quantity_compliant == "yes") %>%
  na.omit(butyrate_mean) #drop any samples with NA in named columns

# Generate a plot of the [butyrate] of each supplement type, week 3 only  
butyrate_long %>%
  filter(study_week == "week3") %>%
  ggplot(aes(x = frequency, 
             y = butyrate_mean)) + 
  geom_violin() # + geom_jitter()
```

In the plots created above, notice the widest part of the twice daily category appears slightly higher than once daily. This means most of the data points in the 2x group are of a higher concentration that those in the 1x group. However the top of the violin in the 1x group is higher than the 2x, indicating the 1x group's maximum value is greater. Discuss with your neighbor, do you think the butyrate concentrations of these two groups (1x vs. 2x) are different? 

### Checking assumptions
In the sections above we observed trends in the data, but this is not sufficient for research purposes. Scientists use statistics to determine the probability that these trends are real. Before we can dive into using a statistical test, we have to determine if our data are appropriate for the test of interest, otherwise we might have more confidence in the results than we should. We do this by checking the assumptions of the tests. 

In the violin plot above, we want to determine if the butyrate concentrations in 1xdaily potato starch consumers is different from that of the 2xdaily potato starch consumers. The plot indicates this might be the case. To answer this question we are comparing two means, to do this we use the student's t-test. A t-test requires the following assumptions to be met: 

* Relatively large sample size (usually > 30)
* The samples have to come from a normal distribution
* We are also going to check if the variances of the groups are equal, because this will determine some of the t.test() arguments

##### Sample size
```{r}
# check sample size
butyrate_long %>%
  filter(study_week == "week3") %>% #subset long data frame in same manner as for plot
  group_by(frequency) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group

#sample size assumption is met
```

##### Normality 
```{r}
# normal distribution 
but_df <- butyrate_long %>%
  filter(study_week == "week3") #subset long data frame in same manner as for plot

shapiro.test(but_df$butyrate_mean) #call column of df with values = vector

#p-value of 2.479e-05 indicates that this is very unlikely to be normal.
```
Here a small p-value indicates these samples differ from a normal distribution. When I have a result with a small p-value I always check how much the distrubtion deviates from normal with a histogram:

```{r}
ggplot(but_df, aes(x=butyrate_mean)) +
  geom_histogram() #histograms show the number of data points (count) at each value

qqnorm(but_df$butyrate_mean); qqline(but_df$butyrate_mean)

#Residuals start above the line, go below, and then above - normality may not be the best model
```
This histogram shows a rough bell curve, in combination with our large sample size we are okay with proceeding with a t-test. 

#### Equal variances 
Finally we are going to determine if the groups we would like to compare (1xdaily and 2xdaily) have equal variances (homogeneity). 
```{r}
# code to extract first group (1xdaily)
once_grp <- butyrate_long %>%
  filter(study_week == "week3",
         frequency == "1xdaily") 

# code to extract second group (2xdaily)
twice_grp <- butyrate_long %>%
  filter(study_week == "week3",
         frequency == "2xdaily") 
```

```{r}
var.test(x = once_grp$butyrate_mean, 
         y = twice_grp$butyrate_mean, 
         alternative = "two.sided")

#The p-value is <.05, which supports the alternative hypothesis that the true ratio of variances is not equal to 1
```
A low p-value indicates the variances are not equal, we will account for this in our test in the next section. 

### T-test between categorical variables
The test you will probably use most frequently is the t-test; and this test determines if the means of two groups are equal. First we need to extract the data we will use for the test: 

```{r}
# use groups extracted above for the test 
t.test(x = once_grp$butyrate_mean, 
       y = twice_grp$butyrate_mean,
       alternative = "less", paired = FALSE, var.equal = FALSE)
```
A large p-value indicates the means of the two groups are not different. 

### Paired t-test
As we've discussed in Friday lectures, everyone has a unique microbiome. We should compare week 1 and week 3 concentrations of all individuals who consumed BRMPS, and determine if the addition of the supplement results in generally higher fecal butyrate concentrations for most individuals. This is accomplished with a special flavor of t-test called a paired t-test. Paired t-tests are used whenever the samples are not independent, such as when the samples are from the same individual over time. 

```{r}
# Same plot as above but use facets to plot both weeks 
butyrate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>% 
  ggplot(aes(x = study_week, 
             y = butyrate_mean, 
             color = study_week), 
         frequency) + 
  geom_violin() + 
  facet_grid(~frequency) + 
  xlab(NULL) + 
  ylab("Butyrate (mmol/kg)") + 
  theme(legend.position = "none")
```
In the figure above it appears there is no difference in weeks for the 1xdaily group, but there may be an increase in the 2xdaily group. 

Before we conduct the statistical test to determine if the observed trends are likely true, we must check our assumptions.
```{r}
# sample size
butyrate_long %>%
  filter(study_week == "week1" | study_week == "week3", 
         supplement_consumed == "BRMPS") %>%  #subset long data frame in same manner as plot
  group_by(frequency, study_week) %>% #set groups to what we are comparing
  summarise(sample_size = n()) #use summarise() and n() to get counts of ppl in each group
```

```{r}
# Check assumptions for each week of the 2xdaily groups 
wk1_2x <- butyrate_long %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS", 
         frequency == "2xdaily") 
shapiro.test(wk1_2x$butyrate_mean) 
ggplot(wk1_2x, aes(x = butyrate_mean)) + geom_histogram()

wk3_2x <- butyrate_long %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS", 
         frequency == "2xdaily") 
shapiro.test(wk3_2x$butyrate_mean) 
ggplot(wk3_2x, aes(x = butyrate_mean)) + geom_histogram()

# join these data frames back together
x2_df <- inner_join(x = wk1_2x, y = wk3_2x,
                    by = c("participant_id", "frequency", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(butyrate_mean_wk1 = butyrate_mean.x,
         butyrate_mean_wk3 = butyrate_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = x2_df$butyrate_mean_wk1, y = x2_df$butyrate_mean_wk3, 
       alternative = "less", paired = TRUE) 
```
For this paired t-test we specified alternative = less because we expect the butyrate concentrations to be higher during week 3. Read the details of the t.test() help page for options for the alternative argument.

The p-value is 0.07 which for a complex biological system (like the gut microbiome) is low! The pattern we observed in the figure is likely a real trend. We can say with confidence that the butyrate concentrations between weeks 1 and 3 are not equal for individuals who consumed BRMPS twice daily. 

### Non-parametric test
What if our data set does not meet any of the assumptions for the test? We just use another test. A t-test is a parametric test, and the non-parametric counterpart is the Mann-Whitney-U test (also called a two-sample Wilcoxon test).
```{r}
# same arguments, just a different function call. 
wilcox.test(x = x2_df$butyrate_mean_wk1, 
            y = x2_df$butyrate_mean_wk3, 
            alternative = "less", paired = TRUE)
```

# Homework 5.1
Repeat the process to conduct the paired t-test for the 1xdaily group. Remember to check the assumptions. Write your conclusions regarding the test as a comment at the end of the code block. 
```{r}
# copy + paste code, and update column and dataframes names to run test
wk1_1x <- butyrate_long %>%
  filter(study_week == "week1", 
         supplement_consumed == "BRMPS", 
         frequency == "1xdaily") 
shapiro.test(wk1_2x$butyrate_mean) #p-value of 0.3089 indicates normality
ggplot(wk1_2x, aes(x = butyrate_mean)) + geom_histogram()

wk3_1x <- butyrate_long %>%
  filter(study_week == "week3", 
         supplement_consumed == "BRMPS", 
         frequency == "1xdaily") 
shapiro.test(wk3_2x$butyrate_mean) #p-value of 0.566 indicates normality
ggplot(wk3_2x, aes(x = butyrate_mean)) + geom_histogram()

# join these data frames back together
x1_df <- inner_join(x = wk1_1x, y = wk3_1x,
                    by = c("participant_id", "frequency", 
                           "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(butyrate_mean_wk1 = butyrate_mean.x,
         butyrate_mean_wk3 = butyrate_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = x1_df$butyrate_mean_wk1, y = x1_df$butyrate_mean_wk3, 
       alternative = "less", paired = TRUE) 

#The p-value is 0.2367, so We can say with confidence that the butyrate concentrations between weeks 1 and 3 are equal for individuals who consumed BRMPS once daily. 
```

# Homework 5.2
Generate plots to determine if methane, acetate, propionate increased during week 3 of the study. Generate plot to determine if pH decreased during week 3 of the study. Save plots to folder called `figures`. 
```{r}
#breath methane
ch4_long <- breath_wkly %>% 
  rename_all(tolower) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS",
         quantity_compliant == "yes",
         study_week == "week1" | study_week == "week3") %>%
  na.omit(ch4_mean)

#violin plot
ch4_violin_plot <- ch4_long %>%
  ggplot(aes(x = study_week, 
             y = ch4_mean)) + 
  geom_violin() +
  labs(title = "Methane mean violin plot")
ch4_violin_plot

#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/ch4_violin_plot.pdf",
          plot = ch4_violin_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#Week3 mean looks slightly higher. Both week1 and week3 plots look unimodal, but the data is majorly skewed to the right. Therefore, we will proceed with a non-parametric test.
```

```{r}
# acetate
acetate_long <- scfa_long %>% 
  select(-starts_with("but"), -starts_with("pro"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS",
         study_week == "week1" | study_week == "week3",
         quantity_compliant == "yes") %>%
  na.omit(acetate_mean)

acetate_violin_plot <- acetate_long %>%
  ggplot(aes(x = study_week, 
             y = acetate_mean)) + 
  geom_violin() +
  labs(title = "Acetate mean violin plot")
acetate_violin_plot

#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/acetate_violin_plot.pdf",
          plot = acetate_violin_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#widest portion of week3 slightly higher than week1, though week1 shows more range. both appear unimodal and skewed right
```

```{r}
# propionate
propionate_long <- scfa_long %>% 
  select(-starts_with("ace"), -starts_with("but"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS",
         study_week == "week1" | study_week == "week3",
         quantity_compliant == "yes") %>%
  na.omit(propionate_mean)

propionate_violin_plot <- propionate_long %>%
  ggplot(aes(x = study_week, 
             y = propionate_mean)) + 
  geom_violin() +
  labs(title = "Propionate mean violin plot")
propionate_violin_plot

#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/propionate_violin_plot.pdf",
          plot = propionate_violin_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#much greater range in week3, which looks more unimodal and skews to the right compared to week1, which looks slightly bimodal. Widest part of week3 is lower than the widest part of week1.
```

```{r}
# pH
ph_long <- pH_wkly %>% 
  rename_all(tolower) %>% 
  select(-starts_with("ace"), -starts_with("but"), -ends_with("median")) %>%
  filter(semester != "Winter2015",
         supplement_consumed == "BRMPS",
         study_week == "week1" | study_week == "week3",
         quantity_compliant == "yes") %>%
  na.omit(ph_mean)

ph_violin_plot <- ph_long %>%
  ggplot(aes(x = study_week, 
             y = ph_mean)) + 
  geom_violin() +
  labs(title = "Mean PH violin plot")
ph_violin_plot

#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/ph_violin_plot.pdf",
          plot = ph_violin_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#mean appears to be lower for week3, looks more obviously bimodal
```

# Homework 5.3
Check assumptions on data sets for individuals who consumed BRMPS: breath methane, pH, acetate, propionate
```{r}
# breath methane

#check conditions for week 1 sample size
ch4_long %>%
  filter(study_week == "week1" | study_week == "week3") %>% 
  group_by(study_week) %>% 
  summarise(sample_size = n()) #153, 139 > 30. 

#normality test for week 1 ph samples
wk1_ch4 <- ch4_long %>%
  filter(study_week == "week1") 
shapiro.test(wk1_ch4$ch4_mean) #with such a small p-value of 2.2e-16, the null hypothesis that the data are normally distributed is rejected
#visually checking normality
ch4_wk1_plot <- ggplot(wk1_ch4, aes(x = ch4_mean)) + geom_histogram()
ch4_wk1_plot #appears unimodal but very skewed and noncontinuous
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/ch4_wk1_normality_histogram.pdf",
          plot = ch4_wk1_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#normality test for week 3 ph samples
wk3_ch4 <- ch4_long %>%
  filter(study_week == "week3") 
shapiro.test(wk3_ch4$ch4_mean) #p-value: 2.2e-16
#visually checking normality
ch4_wk3_plot <- ggplot(wk3_ch4, aes(x = ch4_mean)) + geom_histogram()
ch4_wk3_plot #appears unimodal but skewed and noncontinuous
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/ch4_wk3_normality_histogram.pdf",
          plot = ch4_wk3_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#comparing equal variances for ph samples
week1_ch4_grp <- ch4_long %>%
  filter(study_week == "week1") 
week2_ch4_grp <- ch4_long %>%
  filter(study_week == "week3") 
var.test(x = week1_ch4_grp$ch4_mean, 
         y = week2_ch4_grp$ch4_mean, 
         alternative = "two.sided")
#p value of 2.2e-16 is incredibly small, indicates unequal variances

#Since the data is majorly skewed to the right (not normal), we will proceed with a non-parametric test. 
```

```{r}
# acetate

#check conditions for week 1 sample size
acetate_long %>%
  filter(study_week == "week1" | study_week == "week3") %>% 
  group_by(study_week) %>% 
  summarise(sample_size = n())  #131, 128 > 30 

#normality test for week 1 acetate samples
wk1_acetate <- acetate_long %>%
  filter(study_week == "week1") 
shapiro.test(wk1_acetate$acetate_mean) #p-value: 4.04e-08
#visually checking normality
acetate_wk1_plot <- ggplot(wk1_acetate, aes(x = acetate_mean)) + geom_histogram() #appears unimodal, skewed right
acetate_wk1_plot
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/acetate_wk1_normality_histogram.pdf",
          plot = acetate_wk1_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#normality test for week 3 acetate samples
wk3_acetate <- acetate_long %>%
  filter(study_week == "week3") 
shapiro.test(wk3_acetate$acetate_mean) #p-value of 0.0007166
#visually checking normality
acetate_wk3_plot <- ggplot(wk3_acetate, aes(x = acetate_mean)) + geom_histogram() #most like unimodal... "jagged" appearance
acetate_wk3_plot
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/acetate_wk3_normality_histogram.pdf",
          plot = acetate_wk3_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#comparing equal variances for week 1 acetate samples
week1_ace_grp <- acetate_long %>%
  filter(study_week == "week1") 
week2_ace_grp <- acetate_long %>%
  filter(study_week == "week3") 
var.test(x = week1_ace_grp$acetate_mean, 
         y = week2_ace_grp$acetate_mean, 
         alternative = "two.sided") #p-value is 0.9024, indicates equal variances

#Given our large sample sizes, we will proceed with a parametric paired t-test.
```

```{r}
# propionate

#check conditions for week 1 sample size
propionate_long %>%
  filter(study_week == "week1" | study_week == "week3") %>% 
  group_by(study_week) %>% 
  summarise(sample_size = n()) #117, 124 > 30 

#normality test for week 1 propionate samples
wk1_propionate <- propionate_long %>%
  filter(study_week == "week1") 
shapiro.test(wk1_propionate$propionate_mean) #p-value = 0.01344 ndicates that normality is unlikely
#visually checking for normality
propionate_wk1_plot <- ggplot(wk1_propionate, aes(x = propionate_mean)) + geom_histogram()
propionate_wk1_plot #may be bimodal?
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/propionate_wk1_normality_histogram.pdf",
          plot = propionate_wk1_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#normality test for week 3 prop samples
wk3_propionate <- propionate_long %>%
  filter(study_week == "week3") 
shapiro.test(wk3_propionate$propionate_mean) #p-value = 1.178e-08 indicates that normality is unlikely
#visually checking for normality 
propionate_wk3_plot <- ggplot(wk3_propionate, aes(x = propionate_mean)) + geom_histogram()
propionate_wk3_plot #appears unimodal
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/propionate_wk3_normality_histogram.pdf",
          plot = propionate_wk3_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#comparing equal variances 
week1_pro_grp <- propionate_long %>%
  filter(study_week == "week1") 
week2_pro_grp <- propionate_long %>%
  filter(study_week == "week3") 
var.test(x = week1_pro_grp$propionate_mean, 
         y = week2_pro_grp$propionate_mean, 
         alternative = "two.sided") #p-value of 0.0005322 is very low, indicates unequal variances

#Given our large sample sizes, we will proceed with a parametric paired t-test.
```

```{r}
# pH

#check conditions for week 1 sample size
ph_long %>%
  filter(study_week == "week1" | study_week == "week3") %>% 
  group_by(study_week) %>% 
  summarise(sample_size = n()) #94, 123 > 30 

#normality test for week 1 ph samples
wk1_ph <- ph_long %>%
  filter(study_week == "week1") 
shapiro.test(wk1_ph$ph_mean) #p-value = 0.09902 indicates this is fairly normal
#visually checking for normality
ph_wk1_plot <- ggplot(wk1_ph, aes(x = ph_mean)) + geom_histogram()
ph_wk1_plot
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/ph_wk1_normality_histogram.pdf",
          plot = ph_wk1_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#normality test for week 3 ph samples
wk3_ph <- ph_long %>%
  filter(study_week == "week3") 
shapiro.test(wk3_ph$ph_mean) #p-value = 0.01564 indicates that normality is unlikely
#visually checking for normality
ph_wk3_plot <- ggplot(wk3_ph, aes(x = ph_mean)) + geom_histogram()
ph_wk3_plot
#saving plots:
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/ph_wk3_normality_histogram.pdf",
          plot = ph_wk3_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

#comparing equal variances for ph samples
week1_ph_grp <- ph_long %>%
  filter(study_week == "week1") 
week2_ph_grp <- ph_long %>%
  filter(study_week == "week3") 
var.test(x = week1_ph_grp$ph_mean, 
         y = week2_ph_grp$ph_mean, 
         alternative = "two.sided") #p-value of 0.0311 is low, indicates that the variances are not equal 

#Given our large sample sizes, we will proceed with a parametric paired t-test.
```

# Homework 5.4
Conduct the appropriate statistical tests to determine if patterns observed in plots are significant. Write your interpretations of the results as a comment after the statistical tests.
```{r}
# breath methane

# join these data frames back together
ch4_df <- inner_join(x = wk1_ch4, y = wk3_ch4,
                    by = c("participant_id", "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(ch4_mean_wk1 = ch4_mean.x,
         ch4_mean_wk3 = ch4_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
wilcox.test(x = ch4_df$ch4_mean_wk1, y = ch4_df$ch4_mean_wk3, 
       alternative = "less", paired = TRUE, var.equal = FALSE) 

#A low p-value of 0.00283 indicates that we should reject the null hypothesis - the wk1 and wk3 methane means are statistically different. We can say with confidence that the methane concentrations between weeks 1 and 3 are not equal for individuals who consumed BRMPS.
```

```{r}
# acetate

# join these data frames back together
acetate_df <- inner_join(x = wk1_acetate, y = wk3_acetate,
                    by = c("participant_id", "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(acetate_mean_wk1 = acetate_mean.x,
         acetate_mean_wk3 = acetate_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = acetate_df$acetate_mean_wk1, y = acetate_df$acetate_mean_wk3, 
       alternative = "less", paired = TRUE, var.equal = TRUE) 

#A very low p-value of 0.007261 indicates that we should reject the null hypothesis - the wk1 and wk3 acetate means are statistically different. We can say with confidence that the acetate concentrations between weeks 1 and 3 are not equal for individuals who consumed BRMPS.
```

```{r}
# propionate

# join these data frames back together
propionate_df <- inner_join(x = wk1_propionate, y = wk3_propionate,
                    by = c("participant_id", "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(propionate_mean_wk1 = propionate_mean.x,
         propionate_mean_wk3 = propionate_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = propionate_df$propionate_mean_wk1, y = propionate_df$propionate_mean_wk3, 
       alternative = "less", paired = TRUE, var.equal = FALSE)

#A p-value = 0.3541 indicates that we fail to reject the null hypothesis - the wk1 and wk3 propionate means are statistically the same. We can say with confidence that the propionate concentrations between weeks 1 and 3 are equal for individuals who consumed BRMPS.
```

```{r}
# pH

# join these data frames back together
ph_df <- inner_join(x = wk1_ph, y = wk3_ph,
                    by = c("participant_id", "semester", "supplement_consumed", "quantity_compliant")) %>%
  rename(ph_mean_wk1 = ph_mean.x,
         ph_mean_wk3 = ph_mean.y) %>%
  select(-starts_with("study_week"))

# code to run paired t-test 
t.test(x = ph_df$ph_mean_wk1, y = ph_df$ph_mean_wk3, 
       alternative = "greater", paired = TRUE, var.equal = FALSE) 

#A p-value = 0.002893 indicates that we reject the null hypothesis - the wk1 and wk3 PH means are statistically different. We can say with confidence that the acetate concentrations between weeks 1 and 3 are not equal for individuals who consumed BRMPS.
```


# ANOVA
As you know, we have more than two starch groups we would like to analyze. Instead of doing multiple pairwise comparisons with t-tests (which isn't the best approach because of reasons ...) we use an ANOVA, which compares all categorical groups to one another. 

To illustrate when an ANOVA would be useful, use the `scfa_wide` data frame imported above, plot the delta butyrate vs. supplement type. 
```{r}
scfa_wide %>%
  ggplot(aes(x = supplement_consumed,
             y = delta_butyrate,
             color = supplement_consumed)) +
  geom_hline(yintercept = 0,
             linetype = "dashed") + 
  geom_violin() + 
  geom_jitter() + 
  xlab(NULL) +
  ylab("Butyrate mmol/kg (wk3 - wk1)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

### Check assumptions

As with the t-tests, there are assumptions to check before running an ANOVA. 
```{r}
# check sample sizes
scfa_wide %>%
  group_by(supplement_consumed) %>%
  summarise(sample_size = n())

#supplements w/ sample sizes < 30: arabino (20), BRMPS+Accessible (18), LOODAT (18), none (28), psyllium (13), psyllium+BRMPS (17)
```

Divide the labor with your neighbors and run the normality check on each of the 12 supplements. The first few have been completed as an example.
```{r}
# check normality of each group 
s1 <- scfa_wide %>%
  filter(supplement_consumed == "Accessible") 
shapiro.test(s1$delta_butyrate) #p-value = 0.6886

s2 <- scfa_wide %>%
  filter(supplement_consumed == "Arabino") 
shapiro.test(s2$delta_butyrate) #p-value = 0.7785

s3 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS+Accessible")
shapiro.test(s3$delta_butyrate) #p-value = 0.4633

s4 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize") 
shapiro.test(s4$delta_butyrate) #p-value = 0.7113

s5 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize+BRMPS") 
shapiro.test(s5$delta_butyrate) #p-value = 0.6287

s6 <- scfa_wide %>%
  filter(supplement_consumed == "Inulin") 
shapiro.test(s6$delta_butyrate) #p-value = 0.492

s7 <- scfa_wide %>%
  filter(supplement_consumed == "LOODAT") 
shapiro.test(s7$delta_butyrate) #p-value = 0.6976

s8 <- scfa_wide %>%
  filter(supplement_consumed == "none") 
shapiro.test(s8$delta_butyrate) #p-value = 0.0099 - not normal

s9 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium") 
shapiro.test(s9$delta_butyrate) #p-value = 0.2783

s10 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium+BRMPS") 
shapiro.test(s10$delta_butyrate) #p-value = 0.0441 - not normal

s11 <- scfa_wide %>%
  filter(supplement_consumed == "transition_HiMaize") 
shapiro.test(s11$delta_butyrate) #p-value = 0.06542

s12 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS")
shapiro.test(s12$delta_butyrate) #p-value = 0.2537
```

```{r}
# check variances 
bartlett.test(delta_butyrate ~ supplement_consumed, data = scfa_wide) #p-value = 0.1097 > 0.05
# enter arguments with the following formula: continuous ~ categorical 
```

Now that we know our assumptions are reasonably met, we can run the test: 
```{r}
# run anova
aov_results <- aov(delta_butyrate ~ supplement_consumed, data = scfa_wide)
summary(aov_results) #F value of 0.661 - fail to reject null hypothesis, no significant difference 
```


# Homework 5.5
Repeat the processing of checking assumptions to conduct ANOVA on delta acetate and propionate. Create a plot for delta acetate and propionate. Save plots to folder called `figures`. Decide if you should proceed with conducting the ANOVA. Write your interpretations of the results as a comment after the statistical tests.
```{r}
#same sample size as delta butyrate checked earlier

# acetate

acetate_anova_plot <- scfa_wide %>%
  ggplot(aes(x = supplement_consumed,
             y = delta_acetate,
             color = supplement_consumed)) +
  geom_hline(yintercept = 0,
             linetype = "dashed") + 
  geom_violin() + 
  geom_jitter() + 
  xlab(NULL) +
  ylab("Acetate mmol/kg (wk3 - wk1)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
acetate_anova_plot
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/acetate_anova_plot.pdf",
          plot = acetate_anova_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

# check normality of each group 
s1 <- scfa_wide %>%
  filter(supplement_consumed == "Accessible") 
shapiro.test(s1$delta_acetate) #p-value = 0.674

s2 <- scfa_wide %>%
  filter(supplement_consumed == "Arabino") 
shapiro.test(s2$delta_acetate) #p-value = 0.05369

s3 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS+Accessible")
shapiro.test(s3$delta_acetate) #p-value = 0.8305

s4 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize") 
shapiro.test(s4$delta_acetate) #p-value = 0.001526 - not normal (but sample size is 45)

s5 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize+BRMPS") 
shapiro.test(s5$delta_acetate) #p-value = 0.3026

s6 <- scfa_wide %>%
  filter(supplement_consumed == "Inulin") 
shapiro.test(s6$delta_acetate) #p-value = 0.9105

s7 <- scfa_wide %>%
  filter(supplement_consumed == "LOODAT") 
shapiro.test(s7$delta_acetate) #p-value = 0.137

s8 <- scfa_wide %>%
  filter(supplement_consumed == "none") 
shapiro.test(s8$delta_acetate) #p-value = 0.3468

s9 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium") 
shapiro.test(s9$delta_acetate) #p-value = 0.7713 

s10 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium+BRMPS") 
shapiro.test(s10$delta_acetate) #p-value = 0.9725

s11 <- scfa_wide %>%
  filter(supplement_consumed == "transition_HiMaize") 
shapiro.test(s11$delta_acetate) #p-value = 0.6092

s12 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS")
shapiro.test(s12$delta_acetate) #p-value = 0.02496 - not normal (but sample size is 193)

#check variances
bartlett.test(delta_acetate ~ supplement_consumed, data = scfa_wide) #p-value = 1.167e-05, so variances are unlikely to be equal

#We will proceed with the test - Either the sample size or normality assumption is met for all samples of supplements consumed.

acetate_aov_results <- aov(delta_acetate ~ supplement_consumed, data = scfa_wide)
summary(acetate_aov_results) #We obtain a p-value of 0.137, which shows that the acetate level changes are not the same among the groups.
```

```{r}
# propionate

propionate_anova_plot <- scfa_wide %>%
  ggplot(aes(x = supplement_consumed,
             y = delta_propionate,
             color = supplement_consumed)) +
  geom_hline(yintercept = 0,
             linetype = "dashed") + 
  geom_violin() + 
  geom_jitter() + 
  xlab(NULL) +
  ylab("Propionate mmol/kg (wk3 - wk1)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
propionate_anova_plot
save_plot(filename = "C:/Users/Jules/Documents/UMich_Bio201_F19/Lab5/figures/propionate_anova_plot.pdf",
          plot = propionate_anova_plot,
          nrow = 1, ncol = 1,
          base_aspect_ratio = 1.1)

# check normality of each group 
s1 <- scfa_wide %>%
  filter(supplement_consumed == "Accessible") 
shapiro.test(s1$delta_propionate) #p-value = 6.507e-05 - not normal

s2 <- scfa_wide %>%
  filter(supplement_consumed == "Arabino") 
shapiro.test(s2$delta_propionate) #only two samples, which is too small to test

s3 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS+Accessible")
shapiro.test(s3$delta_propionate) #p-value = 0.8305

s4 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize") 
shapiro.test(s4$delta_acetate) #p-value = 0.001526 - not normal (sample size = 45)

s5 <- scfa_wide %>%
  filter(supplement_consumed == "HiMaize+BRMPS") 
shapiro.test(s5$delta_propionate) #p-value = 0.4316

s6 <- scfa_wide %>%
  filter(supplement_consumed == "Inulin") 
shapiro.test(s6$delta_propionate) #p-value = 0.8973

s7 <- scfa_wide %>%
  filter(supplement_consumed == "LOODAT") 
shapiro.test(s7$delta_propionate) #p-value = 0.8389

s8 <- scfa_wide %>%
  filter(supplement_consumed == "none") 
shapiro.test(s8$delta_propionate) #p-value = 0.1025

s9 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium") 
shapiro.test(s9$delta_propionate) #p-value = 0.1115

s10 <- scfa_wide %>%
  filter(supplement_consumed == "Psyllium+BRMPS") 
shapiro.test(s10$delta_propionate) #p-value = 0.6636

s11 <- scfa_wide %>%
  filter(supplement_consumed == "transition_HiMaize") 
shapiro.test(s11$delta_propionate) #p-value = 0.4711

s12 <- scfa_wide %>%
  filter(supplement_consumed == "BRMPS")
shapiro.test(s12$delta_propionate) #p-value = 6.47e-06 - not normal (sample size = 193)

#check variances
bartlett.test(delta_propionate ~ supplement_consumed, data = scfa_wide) #p-value = 0.00628, so variances are unlikely to be equal

propionate_aov_results <- aov(delta_propionate ~ supplement_consumed, data = scfa_wide)
summary(propionate_aov_results) #We obtain a p-value of 0.197, which shows that the propionate level changes are not the same among the groups.
```

